<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Google Calendar part 1: Integration</title>
    <meta name="description" content="You are about to learn how to allow our users to integrate all of their Google calendars and events within our application. In a series of articles we are going to...">
    
    
    <link rel="preload" href="/assets/css/0.styles.d1fafc99.css" as="style"><link rel="preload" href="/assets/js/app.f0379f84.js" as="script"><link rel="preload" href="/assets/js/2.f113c167.js" as="script"><link rel="preload" href="/assets/js/3.e245ae37.js" as="script"><link rel="prefetch" href="/assets/js/10.463c40b2.js"><link rel="prefetch" href="/assets/js/11.41347932.js"><link rel="prefetch" href="/assets/js/12.160cf6fa.js"><link rel="prefetch" href="/assets/js/13.869049d5.js"><link rel="prefetch" href="/assets/js/14.6ab5dbac.js"><link rel="prefetch" href="/assets/js/15.5b213614.js"><link rel="prefetch" href="/assets/js/16.9b9d25f1.js"><link rel="prefetch" href="/assets/js/17.53e9786c.js"><link rel="prefetch" href="/assets/js/18.407766eb.js"><link rel="prefetch" href="/assets/js/19.ad818b5a.js"><link rel="prefetch" href="/assets/js/20.6a6cbda5.js"><link rel="prefetch" href="/assets/js/21.16473eda.js"><link rel="prefetch" href="/assets/js/22.17daa536.js"><link rel="prefetch" href="/assets/js/23.a3b585a7.js"><link rel="prefetch" href="/assets/js/24.693bd400.js"><link rel="prefetch" href="/assets/js/25.1cb8e654.js"><link rel="prefetch" href="/assets/js/4.32ef7c1a.js"><link rel="prefetch" href="/assets/js/5.1fabd509.js"><link rel="prefetch" href="/assets/js/6.3a66a41c.js"><link rel="prefetch" href="/assets/js/7.9038972a.js"><link rel="prefetch" href="/assets/js/8.0cd2f1f4.js"><link rel="prefetch" href="/assets/js/9.1449d7bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d1fafc99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="content default"><h1 id="google-calendar-part-1-integration"><a href="#google-calendar-part-1-integration" aria-hidden="true" class="header-anchor">#</a> Google Calendar part 1: Integration</h1> <p>You are about to learn how to allow our users to integrate all of their Google calendars and events within our application. In a series of articles we are going to see how to fetch and map Google data into beloved Laravel models and keep that data up-to-date at all times.</p> <p>Whilst your application might not urgently need such integrations, we will go through several patterns and learn some clean ways to clip external data to your projects. If you haven't worked with the Google API before, you will see that it brings lots of challenges and weirdness that require us to be extra vigilant to the organization of our code which makes it a good recreational-programming exercise.</p> <p>In this first article we are going to define our models, set up the Google API as a service and finally fetch, map and display calendars and events.</p> <h2 id="some-first-requirements"><a href="#some-first-requirements" aria-hidden="true" class="header-anchor">#</a> Some first requirements</h2> <p>Before diving into the code, let's take a step back and define the very first specifications of our application.</p> <ul><li>It isn't unlikely that users have more than one Google account. Therefore, it would be good if our application had a page to list, add and delete Google accounts. Each Google account will go through its own OAuth process and will save its own authorization token.</li> <li>We should also import calendars and events upon creation of each Google account and map them into our own representation of those models.</li> <li>Finally we want our users to browse through their events across all of the calendars of all of their Google accounts. For this purpose, we will need a page that sorts event by descending starting time with a little badge that indicates from which calendar this event comes from.</li></ul> <p>Looks like we've found our models.</p> <p><img src="/assets/img/Part-1---Models.653f6087.png" alt="Models"></p> <h2 id="models"><a href="#models" aria-hidden="true" class="header-anchor">#</a> Models</h2> <h3 id="user"><a href="#user" aria-hidden="true" class="header-anchor">#</a> User</h3> <p>The user model stays the same but gets a <code>hasMany</code> relationship to the <code>GoogleAccount</code> model.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">googleAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>GoogleAccount<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="googleaccount"><a href="#googleaccount" aria-hidden="true" class="header-anchor">#</a> GoogleAccount</h3> <p>Every model that comes from the Google API, i.e. <code>GoogleAccount</code>, <code>Calendar</code> and <code>Event</code> have a column <code>google_id</code> which keeps track of the identifier of the resource that Google understands. This will be helpful at a later stage to know if we need to create a new resource or simply update an existing one.</p> <p>For the GoogleAccount model, it will be helpful to ensure a user doesn't enter twice the same account. This model also has a <code>name</code> (typically the email address of the account) and an authentication <code>token</code> which is stored as JSON.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">GoogleAccount</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$fillable</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'google_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'token'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'json'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">calendars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Calendar<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="calendar"><a href="#calendar" aria-hidden="true" class="header-anchor">#</a> Calendar</h3> <p>Aside from its <code>name</code> and <code>google_id</code>, our simplified Calendar model also has a <code>color</code> and a <code>timezone</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Calendar</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$fillable</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'google_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'color'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'timezone'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">googleAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>GoogleAccount<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Event<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="event"><a href="#event" aria-hidden="true" class="header-anchor">#</a> Event</h3> <p>Finally our Event model has a <code>name</code>, a <code>description</code> and a starting and ending <code>datetime</code> with an <code>allday</code> flag letting us know if we should ignore the time of our datetime columns.</p> <p>Instead of just casting our datetime columns, we provide custom accessors to incorporate the calendar's timezone into the parsed Carbon instance. We also define an accessor to retrieve the event's duration.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$with</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'calendar'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$fillable</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'google_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'description'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'allday'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'started_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'ended_at'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">calendar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Calendar<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getStartedAtAttribute</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">asDateTime</span><span class="token punctuation">(</span><span class="token variable">$start</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setTimezone</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">timezone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getEndedAtAttribute</span><span class="token punctuation">(</span><span class="token variable">$end</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">asDateTime</span><span class="token punctuation">(</span><span class="token variable">$end</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setTimezone</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">timezone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getDurationAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">started_at</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">diffForHumans</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ended_at</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/6b9fe6505e6b0deccf32e91ca2f0901f425f41f0" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="enabling-the-google-api"><a href="#enabling-the-google-api" aria-hidden="true" class="header-anchor">#</a> Enabling the Google API</h2> <p>In order to communicate with the Google API, let's start by installing their PHP client.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>composer require google/apiclient
</code></pre></div><p>Next, we need to get some credentials from the API and whitelist a few URIs. This is a pretty long and boring set up so I've externalised it into a gist that describes the entire process with a lot of screenshots.</p> <p>Basically, we will end up with two environment variables <code>GOOGLE_CLIENT_ID</code> and <code>GOOGLE_CLIENT_SECRET</code> and we will whitelist the following URIs also defined as environment variables:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>GOOGLE_REDIRECT_URI<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${APP_URL}</span>/google/oauth&quot;</span>
GOOGLE_WEBHOOK_URI<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${APP_URL}</span>/google/webhook&quot;</span>
</code></pre></div><p><img src="/assets/img/Part-1---Google-verif.7bcc27a5.png" alt="Enabling Google API process"></p> <p>Before you do (or do not) go through this Google API set up, please note a few things:</p> <ul><li><strong>Domain verification</strong> will be necessary when receiving webhook notifications from Google. Therefore it will not be used in the article but in part 3 of this series. However I recommend you to get it over and done with now.</li> <li>I will be using <code>valet share</code> to obtain a <strong>live domain to share to Google</strong>. If you wish to do the same (because you want to try this locally), I highly recommend you to sign up for a <a href="https://ngrok.com/upgrade" target="_blank" rel="noopener noreferrer">free ngrok plan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://joelennon.com/using-reserved-ngrok-subdomains-in-laravel-valet" target="_blank" rel="noopener noreferrer">link it to valet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. If you use ngrok without any account, your server will expire after a few hours which will make you go through a big chunk of the set up again.</li> <li>If you've done this before and you know what you're doing: we’re going to enable the &quot;Google Calendar API&quot; and the &quot;Google+ API&quot;.</li></ul> <p class="text-center">
    ⚡️ Okay so <a href="https://gist.github.com/lorisleiva/36c0173ddf082f1495d25aca119ace7e">here is the gist</a> ⚡️
</p> <p class="text-center">
    See you back in a mo.
</p> <h2 id="google-as-a-service"><a href="#google-as-a-service" aria-hidden="true" class="header-anchor">#</a> Google as a service</h2> <p>Welcome back, 👋 at this point you should be able to add the following variables to your <code>.env</code> file:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>GOOGLE_CLIENT_ID<span class="token operator">=</span>
GOOGLE_CLIENT_SECRET<span class="token operator">=</span>
GOOGLE_REDIRECT_URI<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${APP_URL}</span>/google/oauth&quot;</span>
GOOGLE_WEBHOOK_URI<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${APP_URL}</span>/google/webhook&quot;</span>

<span class="token comment"># In my case:</span>
APP_URL<span class="token operator">=</span>https://b3093b51.ngrok.io
</code></pre></div><p>Within our <code>config/services.php</code> file, we configure a new <code>google</code> service containing everything we need to start up a Google client. It registers our environment variables but also configures some extra options.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    
    <span class="token single-quoted-string string">'google'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token comment">// Our Google API credentials.</span>
        <span class="token single-quoted-string string">'client_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GOOGLE_CLIENT_ID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'client_secret'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GOOGLE_CLIENT_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment">// The URL to redirect to after the OAuth process.</span>
        <span class="token single-quoted-string string">'redirect_uri'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GOOGLE_REDIRECT_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment">// The URL that listens to Google webhook notifications (Part 3).</span>
        <span class="token single-quoted-string string">'webhook_uri'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'GOOGLE_WEBHOOK_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment">// Let the user know what we will be using from his Google account.</span>
        <span class="token single-quoted-string string">'scopes'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token comment">// Getting access to the user's email.</span>
            \<span class="token package">Google_Service_Oauth2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">USERINFO_EMAIL</span><span class="token punctuation">,</span>
            
            <span class="token comment">// Managing the user's calendars and events.</span>
            \<span class="token package">Google_Service_Calendar</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CALENDAR</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        
        <span class="token comment">// Enables automatic token refresh.</span>
        <span class="token single-quoted-string string">'approval_prompt'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'force'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'access_type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'offline'</span><span class="token punctuation">,</span>
        
        <span class="token comment">// Enables incremental scopes (useful if in the future we need access to another type of data).</span>
        <span class="token single-quoted-string string">'include_granted_scopes'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>Whilst the native php client written by Google is quite powerful, we will create a new <code>App\Services\Google</code> class to provide an additional layer of encapsulation that we can control and that acts as our own representation of the interface between the Google API and our application.</p> <p><img src="/assets/img/Part-1---Google-service.02025c69.png" alt="Google service"></p> <p>Whenever we create a new instance of that class, we will boot up an underlying php client with all of the configurations defined earlier.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Services</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$client</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Google_Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setClientId</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.client_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setClientSecret</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.client_secret'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setRedirectUri</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.redirect_uri'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setScopes</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.scopes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setApprovalPrompt</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.approval_prompt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setAccessType</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.access_type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setIncludeGrantedScopes</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.include_granted_scopes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In order to bring all of the power of the underlying client to our <code>Google</code> service, we proxy all method calls to that client through the magic method <code>__call()</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__call</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Call to undefined method '<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$method</span><span class="token punctuation">}</span></span>'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That doesn't stop us from adding more functionalities to our <code>Google</code> class. For example, creating a service with the Google API always follows the convention <code>new \Google_Service_Xxx($client)</code> where <code>Xxx</code> is the capitalised name of the service we want to use. Therefore, we can easily add a little helper for this:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$classname</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;Google_Service_<span class="token interpolation"><span class="token variable">$service</span></span>&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token variable">$classname</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/f6639340f588d49dce5fb8c33f98148c0a14882c" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="managing-google-accounts"><a href="#managing-google-accounts" aria-hidden="true" class="header-anchor">#</a> Managing Google accounts</h2> <h3 id="front-end"><a href="#front-end" aria-hidden="true" class="header-anchor">#</a> Front-end</h3> <p>Before implementing the OAuth process, let's bootstrap a simple page that lists all Google accounts.</p> <p><img src="/assets/img/Screen-Shot-2018-08-17-at-13.40.33.d0ce82f2.png" alt="Screen-Shot-2018-08-17-at-13.40.33"></p> <p>I simply ran <code>php artisan make:auth</code> to generate the typical authentication boilerplate, tweaked the navigation and added a new page.</p> <p>All that's left to do is making our front-end accessible by creating new routes and controllers. Semantically this page calls for a <code>GoogleAccountController</code> with only three actions to list (<code>index</code>), add (<code>store</code>) and delete (<code>destroy</code>) accounts.  We do not need an additional <code>create</code> action to request additional data from the user since all data will be collected through the Google API.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">GoogleAccountController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'auth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'accounts'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'accounts'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccounts</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">,</span> Google <span class="token variable">$google</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO:</span>
        <span class="token comment">// - Handle the OAuth process.</span>
        <span class="token comment">// - Create a new Google Account.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span>GoogleAccount <span class="token variable">$googleAccount</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO:</span>
        <span class="token comment">// - Revoke the authentication token.</span>
        <span class="token comment">// - Delete the Google Account.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, let's define some routes for this controller.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Managing Google accounts.</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.index'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'GoogleAccountController@index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.store'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google/oauth'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'GoogleAccountController@store'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.destroy'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google/{googleAccount}'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'GoogleAccountController@destroy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><small>Note that the <code>store</code> action is using the <code>GET</code> method instead of the typical <code>POST</code> method — for the same reason as before, i.e. we do not request additional data via a form.</small></p> <p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/433195f2af93b00c96d971b918db32f00623e08d" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h3 id="adding-google-accounts"><a href="#adding-google-accounts" aria-hidden="true" class="header-anchor">#</a> Adding Google accounts</h3> <p>Now that we've got our Google service all set up, it is actually pretty simple to navigate the user through the OAuth process. We start by redirecting the user to the Google's consent screen.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Remember that we have access to all the methods of the Google’s client through our encapsulation.</span>
<span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">createAuthUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>At this point the user is in Google land. Once it has logged in and agreed with the scopes of our application, it is redirected back to our <code>GoogleAccountController@store</code> action except that, this time, we receive a <code>code</code> in the body of our request.</p> <p><img src="/assets/img/Part-1---OAuth.2dd68f8f.png" alt="OAuth diagram"></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// We use Laravel's automatic injections to grasp a fresh instance of the Google service by simply type-hinting it.</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">,</span> Google <span class="token variable">$google</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Send the user to the OAuth consent screen.</span>
        <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">createAuthUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Do something with $request-&gt;get('code');</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Return to the account page.</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We then need to use this <code>code</code> in order to generate an authentication <code>token</code> that we can store in our brand new <code>GoogleAccount</code> instance.</p> <p><img src="/assets/img/Part-1---OAuth-final.cd3912e8.png" alt="OAuth diagram final"></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">,</span> Google <span class="token variable">$google</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">createAuthUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Use the given code to authenticate the user.</span>
    <span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'code'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Make a call to the Google+ API to get more information on the account.</span>
    <span class="token variable">$account</span> <span class="token operator">=</span> <span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Plus'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">people</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'me'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">googleAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token comment">// Map the account's id to the `google_id`.</span>
            <span class="token single-quoted-string string">'google_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$account</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token comment">// Use the first email address as the Google account's name.</span>
            <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">head</span><span class="token punctuation">(</span><span class="token variable">$account</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">emails</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">value</span><span class="token punctuation">,</span>
            
            <span class="token comment">// Last but not least, save the access token for later use.</span>
            <span class="token single-quoted-string string">'token'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>updateOrCreate</code> method will first check if there exists a <code>GoogleAccount</code> associated with the authenticated user which also has that <code>google_id</code>. If this is the case, it will simply update the entry instead of creating a new one. This prevents the user from adding multiple times the same Google account but still allows two different users to use the same Google account.</p> <p>Anyway, this is how it looks 👀</p> <p><img src="/assets/img/Kapture-2018-08-17-at-16.35.55.2bd8d217.gif" alt="Animated OAuth process"></p> <p>Before we deal with deleting accounts, let's add a little helper method in our Google service to authenticate the client with a given token.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>By writing this method and returning <code>$this</code>, we can make API calls by chaining methods together.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$google</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><img src="/assets/img/Part-1---Google-service-with-token.42b9f2a5.png" alt="Google service with token"></p> <p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/a9ba39b2ca6ad08f28ac7f55200e6657ab69033f" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h3 id="deleting-google-accounts"><a href="#deleting-google-accounts" aria-hidden="true" class="header-anchor">#</a> Deleting Google accounts</h3> <p>Nothing new here. We've done this countless times.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span>GoogleAccount <span class="token variable">$googleAccount</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, we need to tell Google that we will not be using the token associated to this account anymore. This calls for a new method on the Google service.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">revokeToken</span><span class="token punctuation">(</span><span class="token variable">$token</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$token</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">revokeToken</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span>GoogleAccount <span class="token variable">$googleAccount</span><span class="token punctuation">,</span> Google <span class="token variable">$google</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Event though it has been deleted from our database,</span>
    <span class="token comment">// we still have access to $googleAccount as an object in memory.</span>
    <span class="token variable">$google</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">revokeToken</span><span class="token punctuation">(</span><span class="token variable">$googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/bd25acbfd10a79c86b9a07a6373c65fd0314384b" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="fetching-data"><a href="#fetching-data" aria-hidden="true" class="header-anchor">#</a> Fetching data</h2> <p>Finally, we are all sorted with adding/removing Google accounts and we can start making interesting API calls. For this article we are going to focus on importing everything once. The next couple of articles will deal with how to make sure the imported data stays up-to-date.</p> <h3 id="code-architecture"><a href="#code-architecture" aria-hidden="true" class="header-anchor">#</a> Code architecture</h3> <p>Since importing a lot of data from an API is a long procedural process, it can very quickly make your code dirty. Thus, we will extract that logic into several jobs that each take care of a particular resource type. That is:</p> <ul><li>one job that imports <code>Calendars</code> within a given <code>GoogleAccount</code>.</li> <li>one job that imports <code>Events</code> within a given <code>Calendar</code>.</li></ul> <p>Moreover, the Google API uses an identical process to browse through multiple resources of the same type. So it makes sense for us to implement an abstract super class that orchestrates the logic of browsing through the API whilst the sub classes focus solely on providing the right endpoints and mapping the raw fetched data into a Laravel model.</p> <p>Here is the architecture that we will be using:</p> <p><img src="/assets/img/Part-1---Synchronize-jobs.c88e9970.png" alt="Jobs organization"></p> <p>All jobs are prefixed with <code>Synchronize</code> instead of <code>Fetch</code> because when used multiple times they will update existing resources instead of creating duplicate ones (similar concept to the Google accounts using <code>updateOrCreate()</code> on the <code>google_id</code> column).</p> <p><small>Furthermore, in the next articles, these jobs will support synchronization tokens (from the Google API) in order to fetch the changes in Google's data since the last time the job was called.</small></p> <h3 id="synchronizegoogleresource"><a href="#synchronizegoogleresource" aria-hidden="true" class="header-anchor">#</a> SynchronizeGoogleResource</h3> <p>Let's start with the abstract class. The Google API allows us to browse through its resources by using pagination tokens. This means, at the end of the first call, if there is more data to fetch, we get a <code>nextPageToken</code>. We then need to do the exact same API call again but this time by adding this token in the request. We carry on like this until <code>nextPageToken</code> is <code>null</code> which means there are no more resources to fetch.</p> <p><img src="/assets/img/Part-1---Next-page-tokens.6f3060b8.png#w100" alt="Next page tokens diagram"></p> <p>Let's implement this logic in a job.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Jobs</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizeGoogleResource</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Start with an empty page token.</span>
        <span class="token variable">$pageToken</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Delegate service instantiation to the sub class.</span>
        <span class="token variable">$service</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// Ask the sub class to perform an API call with this pageToken (initially null).</span>
            <span class="token variable">$list</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'pageToken'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$list</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The sub class is responsible for mapping the data into our database.</span>
                <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Get the new page token from the response.</span>
            <span class="token variable">$pageToken</span> <span class="token operator">=</span> <span class="token variable">$list</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getNextPageToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token comment">// Continue until the new page token is null.</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$pageToken</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now, our two sub classes simply need to implement those three abstract functions.</p> <h3 id="synchronizegooglecalendars"><a href="#synchronizegooglecalendars" aria-hidden="true" class="header-anchor">#</a> SynchronizeGoogleCalendars</h3> <p>Here is the skeleton of the job responsible for importing Google calendars.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">SynchronizeGoogleCalendars</span> <span class="token keyword">extends</span> <span class="token class-name">SynchronizeGoogleResource</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithQueue<span class="token punctuation">,</span> Queueable<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$googleAccount</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$googleAccount</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span> <span class="token operator">=</span> <span class="token variable">$googleAccount</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$options</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$googleCalendar</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The first method simply requires us to boot up a new Google client and generate the service associated to the <strong>Google Calendar API</strong>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The second one is also straightforward and only requires us to do a bit of research in the <a href="https://developers.google.com/calendar/v3/reference/" target="_blank" rel="noopener noreferrer">Google API documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$options</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$service</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendarList</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">listCalendarList</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The last one is a bit trickier. We could simply map the <a href="https://developers.google.com/calendar/v3/reference/calendarList" target="_blank" rel="noopener noreferrer">calendar data provided by Google<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> into a new instance of our <code>Calendar</code> model like this:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$googleCalendar</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">calendars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'google_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">summary</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'color'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">backgroundColor</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'timezone'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">timeZone</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, this method is called <code>syncItem</code>, not <code>mapItem</code>. Which means that it will be used all along this series to not only fetch but also update and delete resources. Thus, we must start by upserting our data via the <code>updateOrCreate</code> method.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$googleCalendar</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">calendars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'google_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">summary</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'color'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">backgroundColor</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'timezone'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">timeZone</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally we must find out how to recognise a deleted calendar from Google's API.</p> <p><img src="/assets/img/Screen-Shot-2018-08-17-at-19.52.30.abf3f92a.png" alt="Deleted property from CalendarListItem"></p> <p>It turns out that a <code>CalendarListItem</code> has a <code>deleted</code> boolean indicating whether or not the calendar has been deleted.</p> <p><small>Note that we use items from the <code>CalendarList</code> and not actual calendars since they provide more information, enable us to iterate through them and convey the actual list of calendars that the user wants to use. <a href="https://developers.google.com/calendar/concepts/events-calendars#calendar_and_calendar_list" target="_blank" rel="noopener noreferrer">Read more about this<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in the Google documentation.</small></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$googleCalendar</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">deleted</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">calendars</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google_id'</span><span class="token punctuation">,</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">each</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">calendars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'google_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">summary</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'color'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">backgroundColor</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'timezone'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleCalendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">timeZone</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="synchronizegoogleevents"><a href="#synchronizegoogleevents" aria-hidden="true" class="header-anchor">#</a> SynchronizeGoogleEvents</h3> <p>Very similarly to the previous section, we defined the job responsible for importing <a href="https://developers.google.com/calendar/v3/reference/events" target="_blank" rel="noopener noreferrer">Google events<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from a given <code>Calendar</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">SynchronizeGoogleEvents</span> <span class="token keyword">extends</span> <span class="token class-name">SynchronizeGoogleResource</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithQueue<span class="token punctuation">,</span> Queueable<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>
 
    <span class="token keyword">protected</span> <span class="token variable">$calendar</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$calendar</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span> <span class="token operator">=</span> <span class="token variable">$calendar</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token comment">// We access the token through the `googleAccount` relationship.</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$options</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$service</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">events</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">listEvents</span><span class="token punctuation">(</span>
            <span class="token comment">// We provide the Google ID of the calendar from which we want the events.</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">google_id</span><span class="token punctuation">,</span> <span class="token variable">$options</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">syncItem</span><span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// A Google event has been deleted if its status is `cancelled`.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span> <span class="token operator">===</span> <span class="token single-quoted-string string">'cancelled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google_id'</span><span class="token punctuation">,</span> <span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendar</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'google_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">summary</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'description'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">description</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'allday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAllDayEvent</span><span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token single-quoted-string string">'started_at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">parseDatetime</span><span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">start</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token single-quoted-string string">'ended_at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">parseDatetime</span><span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// See next changes on GitHub to check out these helper methods.</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">isAllDayEvent</span><span class="token punctuation">(</span><span class="token variable">$googleEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">parseDatetime</span><span class="token punctuation">(</span><span class="token variable">$googleDatetime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dispatching-the-jobs"><a href="#dispatching-the-jobs" aria-hidden="true" class="header-anchor">#</a> Dispatching the jobs</h3> <p>Okay so now that our jobs are ready to use, let's make sure they are run every time a new <code>GoogleAccount</code> or <code>Calendar</code> is created.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">GoogleAccount</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$googleAccount</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SynchronizeGoogleCalendars<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$googleAccount</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Calendar</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$calendar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SynchronizeGoogleEvents<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$calendar</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now you can be sure that when the user adds a Google account, it will start importing all of its calendars, which in turn will start importing all of their associated events.</p> <p><small>Note that, when deleting a Google account, all associated data will be deleted only if you used <code>onDelete('cascade')</code> in the relevant relationships of your migrations.</small></p> <p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/7cac0f3a9778df23d4f2aa6021f4dc89a9d5a91d" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="viewing-events"><a href="#viewing-events" aria-hidden="true" class="header-anchor">#</a> Viewing events</h2> <p>After all this work, it will be a shame not to see the data we've imported. Therefore let's bootstrap a little page that lists all of our events ordered by descending starting time (from most recent to oldest).</p> <p>First, we need to create a query that accesses all of the events from a given user. Unfortunately we cannot use the <code>hasManyThrough</code> relationship since the <code>Event</code> model is three levels deep from the <code>User</code> model. That is, we could fetch the calendars (<code>User → GoogleAccount → Calendar</code>) but not one level deeper.</p> <p>There is actually a <a href="https://github.com/staudenmeir/eloquent-has-many-deep" target="_blank" rel="noopener noreferrer">package<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that defines a new Laravel relationship called <code>hasManyDeep</code> which would allow us to reach the <code>Event</code> model from the <code>User</code> model. However, for the purpose of this article, I'd rather not include yet another package. So here is my quick and simple implementation:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Event<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereHas</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'calendar'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$calendarQuery</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$calendarQuery</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereHas</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'googleAccount'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$accountQuery</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$accountQuery</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereHas</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$userQuery</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$userQuery</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Okay next, let's create an <code>EventController</code> with only one <code>index</code> action.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">EventController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$events</span> <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'started_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'desc'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'events'</span><span class="token punctuation">,</span> <span class="token function">compact</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally let's define a route for this.</p> <div class="language-php extra-class"><pre class="language-php"><code>Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'event.index'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'event'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'EventController@index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><small>If you'd like to see the front-end's code, please check the changes on GitHub below.</small></p> <p>Here is what my (made up) calendar events look like on the Google calendar app.</p> <p><img src="/assets/img/Screen-Shot-2018-08-17-at-20.47.06.ea8ffee3.png" alt="Calendar events in the Google app"></p> <p>Here is what they look like on our application. 🍺</p> <p><img src="/assets/img/Screen-Shot-2018-08-17-at-20.47.35.fee14606.png" alt="Calendar events in our Laravel app"></p> <p><small>🐙 <a href="https://github.com/lorisleiva/blog-google-calendar/commit/9989439a256afb5a32d09fdd6dfc5cbeee95c465" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h2> <p>When dealing with any API integration (and especially the Google API), it can be very quickly overwhelming. I've tried to make this article as complete as possible so that we can move on to more interesting things on the next ones. I still hope you had fun during that little journey and that you are excited about the new possibilities that your application can now offer.</p> <p>The next article will deal with synchronizations at regular intervals which means using yet ANOTHER token provided by Google: the <code>syncToken</code>. Instead of giving our existing model the burden of synchronizing themselves we will create a new model that will handle this responsibility.</p> <p>See ya soon 👋</p> <p>⌚️ <a href="/google-calendar-part-2-periodic-synchronizations">Google Calendar part 2: Periodic synchronizations</a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0379f84.js" defer></script><script src="/assets/js/2.f113c167.js" defer></script><script src="/assets/js/3.e245ae37.js" defer></script>
  </body>
</html>
