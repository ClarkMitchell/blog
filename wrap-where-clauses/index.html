<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wrap where clauses | The Viking Dev</title>
    <meta name="description" content="Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables.">
    <link rel="apple-touch-icon" sizes="57x57" href="/blog/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/blog/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/blog/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/blog/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/blog/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/blog/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/blog/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/blog/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/blog/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon-16x16.png">
  <link rel="manifest" href="/blog/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
    <meta property="article:published_time" content="2018-02-21T17:27:00.000Z"><meta property="og:site_name" content="The Viking Dev"><meta property="og:title" content="Wrap where clauses"><meta property="og:description" content="Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables."><meta property="og:type" content="article"><meta property="og:url" content="https://theviking.dev/wrap-where-clauses/"><meta property="og:image" content="https://theviking.dev/covers/wrap-where-clauses.jpg"><meta name="twitter:title" content="Wrap where clauses"><meta name="twitter:description" content="Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables."><meta name="twitter:url" content="https://theviking.dev/wrap-where-clauses/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://theviking.dev/covers/wrap-where-clauses.jpg"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Clark Collins"><meta name="twitter:creator" content="@thevikingdev"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="Laravel Lab"><meta property="article:tag" content="Laravel Lab">
    <link rel="preload" href="/blog/assets/css/0.styles.d99ab260.css" as="style"><link rel="preload" href="/blog/assets/js/app.b02e3da3.js" as="script"><link rel="preload" href="/blog/assets/js/16.70496577.js" as="script"><link rel="preload" href="/blog/assets/js/1.9159594d.js" as="script"><link rel="preload" href="/blog/assets/js/3.b7f3e871.js" as="script"><link rel="preload" href="/blog/assets/js/27.58c189b7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.3a4d6e5d.js"><link rel="prefetch" href="/blog/assets/js/11.e526cffd.js"><link rel="prefetch" href="/blog/assets/js/12.97dd4e76.js"><link rel="prefetch" href="/blog/assets/js/13.bebc3034.js"><link rel="prefetch" href="/blog/assets/js/14.23988923.js"><link rel="prefetch" href="/blog/assets/js/15.42ab546a.js"><link rel="prefetch" href="/blog/assets/js/17.413a23ac.js"><link rel="prefetch" href="/blog/assets/js/18.5292ea4b.js"><link rel="prefetch" href="/blog/assets/js/19.0d345e74.js"><link rel="prefetch" href="/blog/assets/js/20.5a4e6c3e.js"><link rel="prefetch" href="/blog/assets/js/21.b4dde55d.js"><link rel="prefetch" href="/blog/assets/js/22.aaadc110.js"><link rel="prefetch" href="/blog/assets/js/23.50b13f8e.js"><link rel="prefetch" href="/blog/assets/js/24.f446bdf5.js"><link rel="prefetch" href="/blog/assets/js/25.da4ae978.js"><link rel="prefetch" href="/blog/assets/js/26.b06a0d31.js"><link rel="prefetch" href="/blog/assets/js/28.99f6a6bd.js"><link rel="prefetch" href="/blog/assets/js/29.ba7aee4a.js"><link rel="prefetch" href="/blog/assets/js/30.31845046.js"><link rel="prefetch" href="/blog/assets/js/31.e03dc770.js"><link rel="prefetch" href="/blog/assets/js/32.71d8cf23.js"><link rel="prefetch" href="/blog/assets/js/33.a1979bf1.js"><link rel="prefetch" href="/blog/assets/js/34.13272317.js"><link rel="prefetch" href="/blog/assets/js/35.657aefdb.js"><link rel="prefetch" href="/blog/assets/js/4.e03f3a74.js"><link rel="prefetch" href="/blog/assets/js/5.2411cf68.js"><link rel="prefetch" href="/blog/assets/js/6.7bdb70cf.js"><link rel="prefetch" href="/blog/assets/js/7.8a9a58e3.js"><link rel="prefetch" href="/blog/assets/js/8.1ab54f34.js"><link rel="prefetch" href="/blog/assets/js/9.2607238a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d99ab260.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><div class="h-3" style="animation:movingGradient 20s linear infinite;background-size:700% 100%;background-image:linear-gradient(120deg, #FFBE0B, #FB5607, #FF006E, #8338EC, #3A86FF, #FFBE0B, #FB5607);width:100%;transition:width .3s linear;"></div> <div class="container my-16"><div class="text-black font-serif font-semibold text-4xl md:text-5xl leading-tight mr-12 sm:mr-20 lg:mr-0">Wrap where clauses</div> <!----></div></div> <div><div class="floating-header fixed pin-x pin-t pt-2 pb-3 sm:pt-3 sm:pb-4 shadow z-floating-header"><div class="container-lg"><div class="flex items-center"><div class="flex-1 flex items-center"><a href="/blog/" class="block border-0 router-link-active"><div class="w-5 h-5"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon-home"><path class="primary" d="M9 22H5a1 1 0 0 1-1-1V11l8-8 8 8v10a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-4a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v4a1 1 0 0 1-1 1zm3-9a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path><path class="secondary" d="M12.01 4.42l-8.3 8.3a1 1 0 1 1-1.42-1.41l9.02-9.02a1 1 0 0 1 1.41 0l8.99 9.02a1 1 0 0 1-1.42 1.41l-8.28-8.3z"></path></svg></div></a> <div class="flex-1 font-serif font-medium ml-3 mr-4 w-5 h-5 truncate">Wrap where clauses</div></div> <div class="hidden sm:flex items-center"><div class="uppercase tracking-wide text-sm font-semibold text-grey-dark mr-3">
                    share
                </div> <a href="https://twitter.com/share?text=Wrap%20where%20clauses&amp;url=https://theviking.dev/wrap-where-clauses/" onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;" class="block border-0 leading-tight text-grey-dark hover:text-blue-light mr-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-4 h-4 fill-current"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://theviking.dev/wrap-where-clauses/" onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;" class="block border-0 leading-tight text-grey-dark hover:text-blue-dark"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 264 512" class="w-4 h-4 fill-current"><path d="M215.8 85H264V3.6C255.7 2.5 227.1 0 193.8 0 124.3 0 76.7 42.4 76.7 120.3V192H0v91h76.7v229h94V283h73.6l11.7-91h-85.3v-62.7c0-26.3 7.3-44.3 45.1-44.3z"></path></svg></a></div></div></div> <div class="absolute pin-x pin-b h-1" style="animation:movingGradient 20s linear infinite;background-size:700% 100%;background-image:linear-gradient(120deg, #FFBE0B, #FB5607, #FF006E, #8338EC, #3A86FF, #FFBE0B, #FB5607);width:0%;transition:width .3s linear;"></div></div> <div class="container mb-8"><div class="flex flex-col sm:flex-row sm:items-center text-grey-darker font-semibold bg-grey-lightest border-t border-b border-grey px-4 py-2 overflow-hidden"><div class="flex flex-no-shrink items-center mb-2 sm:mb-0 sm:mr-6"><div class="w-5 h-5 flex-no-shrink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon-calendar"><path class="primary" d="M5 4h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6c0-1.1.9-2 2-2zm0 5v10h14V9H5z"></path><path class="secondary" d="M7 2a1 1 0 0 1 1 1v3a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm10 0a1 1 0 0 1 1 1v3a1 1 0 0 1-2 0V3a1 1 0 0 1 1-1z"></path></svg></div> <div class="ml-2 flex-no-shrink">21/02/2018</div></div> <div class="flex flex-no-shrink items-center"><div class="w-5 h-5 flex-no-shrink"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon-tag"><path class="primary" d="M2.59 13.41A1.98 1.98 0 0 1 2 12V7a5 5 0 0 1 5-5h4.99c.53 0 1.04.2 1.42.59l8 8a2 2 0 0 1 0 2.82l-8 8a2 2 0 0 1-2.82 0l-8-8zM7 9a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path><path class="secondary" d="M12 18l6-6-4-4-6 6.01L12 18z"></path></svg></div> <div class="ml-2 flex-no-shrink">Laravel Lab</div></div></div></div> <div class="content default content__default"><h1 id="wrap-where-clauses"><a href="#wrap-where-clauses" aria-hidden="true" class="header-anchor">#</a> Wrap where clauses</h1> <p>Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables.</p> <h2 id="an-example-of-increased-relationship"><a href="#an-example-of-increased-relationship" aria-hidden="true" class="header-anchor">#</a> An example of increased relationship</h2> <p>Let's say an <code>Article</code> has some <code>Images</code> and some <code>Comments</code> which also have some <code>Images</code>. The <code>Image</code> model is linked to the <code>Article</code> and <code>Comment</code> models via a polymorphic relationship.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphMany</span><span class="token punctuation">(</span>Image<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">comments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Comment<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now, how would we go about fetching all images from an article including the images of its comments?</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getAllImagesAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$commentImages</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">comments</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">flatMap</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">images</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">images</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token variable">$commentImages</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>While this works fine, we have to fetch all comments and then for each of those comments fetch their images. If we have 100 comments, thats 101 queries just to fetch some images. How can we transform this into a simple Laravel relationship method that can be cached and requires only one database query?</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span> <span class="token punctuation">{</span>        
        <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'imageable_type'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'App\Comment'</span><span class="token punctuation">)</span>
              <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereExists</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span>\<span class="token package">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'comments'</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereRaw</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'comments.id = image.imageable_id'</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'article_id'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's run through that code:</p> <ol><li>We use the original <code>images()</code> relationship and add a <em>&quot;OR&quot; where clause</em> to extend it.</li> <li>In our <em>&quot;OR&quot; where clause</em>, we only want images that are linked to comments. Note that we already have the images associates with our article within the first part of the &quot;OR&quot;.</li> <li>Finally we only want images <code>where there exists</code> a row from the <code>comments</code> table such that its <code>id</code> equals our <code>imageable_id</code> and such that its <code>article_id</code> matches the id of our article.</li></ol> <p>Easy right? Now we can fully leverage the <code>allImages()</code> method as if it was a regular relationship method:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">allImages</span><span class="token punctuation">;</span> <span class="token comment">// Get them all.</span>
<span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get the last once.</span>
<span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Count them.</span>
</code></pre></div><h2 id="the-filtering-problem"><a href="#the-filtering-problem" aria-hidden="true" class="header-anchor">#</a> The filtering problem</h2> <p>Similarly we should be able to filter our relationship method like so:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>However, the filtering above will not work as expected. To understand why, we need to have a look at the SQL query it generates.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">// This first part is generated by `$this-&gt;images()`</span>
<span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span> 
<span class="token keyword">where</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_id<span class="token punctuation">`</span> <span class="token operator">=</span> ?             <span class="token comment">// (A)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_id<span class="token punctuation">`</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>   <span class="token comment">// (B)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_type<span class="token punctuation">`</span> <span class="token operator">=</span> ?         <span class="token comment">// (C)</span>
    
    <span class="token comment">// This second part is our `orWhere` clause. (D)</span>
    <span class="token operator">or</span> <span class="token punctuation">(</span>
        <span class="token punctuation">`</span>imageable_type<span class="token punctuation">`</span> <span class="token operator">=</span> ? 
        <span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
            <span class="token keyword">select</span> <span class="token number">1</span> 
            <span class="token keyword">from</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span> 
            <span class="token keyword">where</span> images<span class="token punctuation">.</span>imageable_id <span class="token operator">=</span> comments<span class="token punctuation">.</span>id <span class="token operator">and</span> <span class="token punctuation">`</span>article_id<span class="token punctuation">`</span> <span class="token operator">=</span> ?
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment">// This third part is our size filtering.    (E)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>size<span class="token punctuation">`</span> <span class="token operator">&lt;</span> ?
</code></pre></div><p>Because of the precedence of <code>and</code> over <code>or</code>, our size filter (E) only gets applied to our <em>&quot;OR&quot; where clause</em> (D), i.e. we are only filtering the images of the comments.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// instead of</span>
<span class="token constant">A</span> <span class="token keyword">and</span> <span class="token constant">B</span> <span class="token keyword">and</span> <span class="token constant">C</span> <span class="token keyword">or</span> <span class="token constant">D</span> <span class="token keyword">and</span> <span class="token constant">E</span>
<span class="token comment">// which translates to</span>
<span class="token punctuation">(</span><span class="token constant">A</span> <span class="token keyword">and</span> <span class="token constant">B</span> <span class="token keyword">and</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token constant">D</span> <span class="token keyword">and</span> <span class="token constant">E</span><span class="token punctuation">)</span>
<span class="token comment">// we want</span>
<span class="token punctuation">(</span><span class="token constant">A</span> <span class="token keyword">and</span> <span class="token constant">B</span> <span class="token keyword">and</span> <span class="token constant">C</span> <span class="token keyword">or</span> <span class="token constant">D</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token constant">E</span>
</code></pre></div><h2 id="macro-to-the-rescue"><a href="#macro-to-the-rescue" aria-hidden="true" class="header-anchor">#</a> Macro to the rescue</h2> <p>To fix this issue, we basically need to wrap all where clauses of our query builder into one nested where clause. I have created a macro that does that for you. I'll just paste it here with some comments if you're interested.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Providers\AppServiceProvider</span>
Relation<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">macro</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wrapWhereClauses'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$boolean</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'and'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Get the query of the relation.</span>
    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create a new nested where group.</span>
    <span class="token variable">$whereGroup</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">forNestedWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Add all the query where clauses to the new where group.</span>
    <span class="token variable">$whereGroup</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Replace the query where clauses to include only this whereGroup.</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'Nested'</span><span class="token punctuation">,</span> 
        <span class="token single-quoted-string string">'query'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$whereGroup</span><span class="token punctuation">,</span> 
        <span class="token single-quoted-string string">'boolean'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$boolean</span>
    <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Return this to continue chaining.</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now just append this to your <code>allImages()</code> method.</p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">wrapWhereClauses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And now, any new where clause will be applied to all of the images as expected.</p></div> <div class="bg-grey-lighter mt-16"><div class="container py-4 sm:py-8"><h2>Related articles</h2> <div class="flex flex-wrap -mx-5"><a href="/blog/using-gitlabs-pipeline-with-laravel/" class="article-card relative flex flex-col rounded-lg shadow-xl hover:shadow-2xl min-h-article-card border-0 z-article-card mx-5 mb-8"><figure><div class="h-48 rounded-t-lg bg-no-repeat bg-cover bg-center" style="background-image:url(/covers/using-gitlabs-pipeline-with-laravel.jpg);"></div></figure> <main class="flex flex-1 flex-col bg-white rounded-b-lg p-6"><header><div class="uppercase tracking-wide text-grey-dark text-sm font-semibold">Laravel Lab</div> <div class="font-sans text-2xl mb-4 border-0 leading-tight text-black font-semibold">Using GitLab's pipeline with Laravel</div></header> <section class="font-content text-lg text-grey-darker">GitLab's pipelines can be scary at first (because you know... Docker) but they're really easy to setup and very helpful. Here's how I set up the pipelines of my Laravel applications on Gitlab.</section></main> <!----></a><a href="/blog/google-calendar-part-2-periodic-synchronizations/" class="article-card relative flex flex-col rounded-lg shadow-xl hover:shadow-2xl min-h-article-card border-0 z-article-card mx-5 mb-8"><figure><div class="h-48 rounded-t-lg bg-no-repeat bg-cover bg-center" style="background-image:url(/covers/google-calendar-part-2-periodic-synchronizations.jpg);"></div></figure> <main class="flex flex-1 flex-col bg-white rounded-b-lg p-6"><header><div class="uppercase tracking-wide text-grey-dark text-sm font-semibold">Laravel Lab</div> <div class="font-sans text-2xl mb-4 border-0 leading-tight text-black font-semibold">Google Calendar part 2: Periodic synchronizations</div></header> <section class="font-content text-lg text-grey-darker">Learn how to periodically synchronize your users' calendars and events from the Google API.</section></main> <!----></a></div></div></div></div> <div class="bg-grey-darkest text-white"><div class="container py-8 flex"><div class="flex-1">
                Find me elsewhere 👉
            </div> <div class="-mx-2"><a href="https://twitter.com/TheVikingDev" class="text-white hover:text-blue-light border-0 mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 fill-current"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a> <a href="https://github.com/ClarkMitchell" class="text-white hover:text-grey border-0 mx-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="w-5 h-5 fill-current"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div></div></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b02e3da3.js" defer></script><script src="/blog/assets/js/16.70496577.js" defer></script><script src="/blog/assets/js/1.9159594d.js" defer></script><script src="/blog/assets/js/3.b7f3e871.js" defer></script><script src="/blog/assets/js/27.58c189b7.js" defer></script>
  </body>
</html>
